<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Tienda</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" defer></script>

    <script defer>
        const API_URL = "/dsaApp";
        let loggedInUser = null;

        $(document).ready(function(){
            loggedInUser = localStorage.getItem("loggedInUser");

            if (!loggedInUser) {
                window.location.href = "login.html";
                return;
            }

            $("#user-display").text(loggedInUser);

            loadShopItems();
            loadInventory(loggedInUser);
            loadUserData(loggedInUser);

            $("#logout-btn").click(function(){
                localStorage.removeItem("loggedInUser");
                mostrarNotificacion("Cerrando sesión...", "exito");
                setTimeout(() => {
                    window.location.href = "login.html";
                }, 1500);
            });

            $("#shop-items-list").on("click", ".buy-btn", function(e){
                e.preventDefault();
                const objectId = $(this).data("id");
                const objectName = $(this).data("name");

                const requestBody = {
                    "nombre": loggedInUser,
                    "objectId": objectId
                };

                fetch(API_URL + "/game/users/objects/buy", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(requestBody)
                })
                    .then(response => {
                        if (response.ok) {
                            return response.json();
                        } else if (response.status === 402) {
                            throw new Error("¡No tienes suficientes monedas!");
                        } else if (response.status === 404) {
                            throw new Error("Objeto o usuario no encontrado");
                        } else {
                            throw new Error("Error desconocido en la tienda");
                        }
                    })
                    .then(updatedUser => {
                        mostrarNotificacion(`¡${objectName} comprado!`, "exito");
                        loadInventory(loggedInUser);
                        $("#coin-display").text(updatedUser.monedas);
                    })
                    .catch(error => {
                        mostrarNotificacion(error.message, "error");
                    });
            });
        });

        function loadShopItems() {
            const listElement = $("#shop-items-list");
            listElement.html('<li class="list-group-item list-group-item-secondary text-center">Cargando objetos...</li>');

            fetch(API_URL + "/game/shop/objects")
                .then(response => response.ok ? response.json() : [])
                .then(items => {
                    listElement.empty();
                    if (items.length === 0) {
                        listElement.append('<li class="list-group-item list-group-item-secondary text-muted">No hay objetos disponibles</li>');
                    } else {
                        items.forEach(item => {
                            const iconClass = getIconForType(item.tipo);
                            listElement.append(`
                                <li class="list-group-item d-flex justify-content-between align-items-center list-group-item-secondary">
                                    <div>
                                        <strong><i class="${iconClass} me-2"></i>${item.nombre}</strong>
                                        <small class="d-block text-muted">${item.descripcion}</small>
                                    </div>
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="badge bg-dark text-warning">${item.precio} <i class="fas fa-coins"></i></span>
                                        <button class="btn btn-success btn-sm buy-btn shadow-sm" data-id="${item.id}" data-name="${item.nombre}">
                                            Comprar
                                        </button>
                                    </div>
                                </li>
                            `);
                        });
                    }
                })
                .catch(error => {
                    console.error("Error cargando objetos de la tienda:", error);
                    listElement.html('<li class="list-group-item list-group-item-secondary text-danger">Error al cargar objetos</li>');
                });
        }

        function getIconForType(tipo) {
            switch(tipo) {
                case "ESPADA": return "fas fa-khanda";
                case "ESCUDO": return "fas fa-shield-alt";
                case "POCION": return "fas fa-flask";
                default: return "fas fa-box";
            }
        }

        function loadInventory(username) {
            const listElement = $("#inventory-list");
            listElement.html('<li class="list-group-item list-group-item-dark text-center">Actualizando...</li>');

            fetch(API_URL + "/game/users/objects/list?nombre=" + username)
                .then(response => response.ok ? response.json() : [])
                .then(items => {
                    listElement.empty();
                    if (items.length === 0) {
                        listElement.append('<li class="list-group-item list-group-item-dark text-muted">Inventario vacío</li>');
                    } else {
                        const grouped = {};
                        items.forEach(item => {
                            const key = item.id || item.nombre;
                            if (!grouped[key]) {
                                grouped[key] = { ...item, cantidad: 0 };
                            }
                            grouped[key].cantidad++;
                        });

                        Object.values(grouped).forEach(item => {
                            const iconClass = getIconForType(item.tipo);
                            listElement.append(`
                                <li class="list-group-item list-group-item-dark d-flex justify-content-between align-items-center">
                                    <span><i class="${iconClass} me-2"></i> ${item.nombre}</span>
                                    <span class="badge bg-light text-dark">${item.cantidad}</span>
                                </li>
                            `);
                        });
                    }
                });
        }

        function loadUserData(username) {
            fetch(API_URL + "/game/users/" + username)
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error("No se pudo cargar el usuario");
                    }
                })
                .then(user => {
                    $("#coin-display").text(user.monedas);
                })
                .catch(error => {
                    console.error("Error cargando monedas:", error);
                    $("#coin-display").text("Error");
                });
        }

        function mostrarNotificacion(mensaje, tipo) {
            const toastElement = document.getElementById('miToast');
            const toastBody = document.getElementById('toastBody');
            toastBody.textContent = mensaje;

            toastElement.classList.remove('text-bg-danger', 'text-bg-success');
            toastElement.classList.add(tipo === "exito" ? 'text-bg-success' : 'text-bg-danger');

            const toast = new bootstrap.Toast(toastElement);
            toast.show();
        }
    </script>
</head>
<body>

<div id="template-bg-1">
    <div class="d-flex flex-column min-vh-100 justify-content-center align-items-center bg-secondary">
        <div class="card p-4 text-light bg-dark mb-5 shadow-lg" style="width: 100%; max-width: 600px;">

            <div class="card-header d-flex justify-content-between align-items-center border-bottom border-secondary pb-3">
                <h3 class="m-0"><i class="fas fa-store me-2"></i>Tienda</h3>
                <div class="d-flex align-items-center gap-3">
                    <div class="badge bg-warning text-dark p-2 fs-6">
                        <i class="fas fa-coins"></i> <span id="coin-display">...</span>
                    </div>

                    <span class="text-info fw-bold"><i class="fas fa-user me-1"></i> <span id="user-display">...</span></span>

                    <button type="button" class="btn btn-outline-danger btn-sm" id="logout-btn">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>

            <div class="card-body w-100 pt-4">

                <h5 class="text-uppercase text-white mb-3 small">Objetos Disponibles</h5>
                <ul class="list-group mb-4" id="shop-items-list">
                </ul>

                <hr class="text-secondary">

                <h5 class="text-uppercase text-white mb-3 small mt-4">Mi Inventario</h5>
                <ul class="list-group" id="inventory-list">
                </ul>

            </div>
        </div>
    </div>
</div>

<div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="miToast" class="toast border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body fw-bold" id="toastBody"></div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

</body>
</html>
